<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!--=============== FAVICON ===============-->
    <link rel="shortcut icon" href="/assets/img/favicon.png" type="image/x-icon">

    <!--=============== REMIXICONS ===============-->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">

    <!--=============== CSS ===============-->
    <link rel="preload" href="/assets/css/styles.css" as="style" onload="this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="/assets/css/styles.css">
    </noscript>

    <style>
        .checkout-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            padding-top: 10rem;
        }

        .checkout-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 3rem;
            align-items: start;
        }

        .checkout-content.full-width {
            grid-template-columns: 1fr;
            gap: 0;
        }

        .checkout-form {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 1rem;
            font-family: var(--second-font);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ff9700;
        }

        .location-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .location-card {
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .location-card:hover {
            border-color: #ff9700;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 151, 0, 0.2);
        }

        .location-card.selected {
            border-color: #ff9700;
            background: linear-gradient(135deg, #fff9f0, #fff3e0);
        }

        .location-card h4 {
            color: #ff9700;
            margin-bottom: 0.5rem;
            font-family: var(--second-font);
        }

        .location-card p {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }

        .location-details {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid #eee;
        }

        .location-details p {
            margin: 0.25rem 0;
            font-size: 0.85rem;
        }

        .hours-display {
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            line-height: 1.3;
        }

        .phone-number {
            color: #ff9700;
            font-weight: bold;
        }

        .order-summary {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 2rem;
        }

        .order-summary.full-screen {
            position: static;
            width: 100%;
            max-width: none;
            margin: 0;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: none;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 1;
        }

        .order-summary.full-screen .summary-header,
        .order-summary.full-screen .order-items,
        .order-summary.full-screen .summary-totals {
            flex: 0 0 auto;
        }

        .order-summary.full-screen .step-actions {
            margin-top: auto;
            padding-top: 2rem;
            border-top: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .order-summary.full-screen .step-actions .step-button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .order-summary.full-screen .step-actions .step-button.prev-step {
            background: #6c757d;
            color: white;
        }

        .order-summary.full-screen .step-actions .step-button.prev-step:hover:not(:disabled) {
            background: #5a6268;
        }

        .order-summary.full-screen .step-actions .step-button.checkout-button {
            background: linear-gradient(135deg, #ff9700, #ff7700);
            color: white;
        }

        .order-summary.full-screen .step-actions .step-button.checkout-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #ff7700, #ff5500);
        }

        .order-summary.full-screen .step-actions .step-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .review-section {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #ff9700;
        }

        .review-section h5 {
            margin: 0 0 0.5rem 0;
            color: #333;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .review-section p {
            margin: 0.25rem 0;
            color: #666;
        }

        @media (max-width: 768px) {
            .order-summary.full-screen {
                padding: 1rem;
            }

            .review-section {
                margin: 1rem 0;
                padding: 0.75rem;
            }
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .summary-header h3 {
            color: #333;
            margin: 0;
            font-family: var(--second-font);
        }

        .order-items {
            margin-bottom: 1.5rem;
        }

        .order-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #ff9700;
        }

        .order-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 6px;
        }

        .item-details {
            flex: 1;
        }

        .item-details h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            color: #ff9700;
            font-family: var(--second-font);
        }

        .item-details p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .item-price {
            font-weight: bold;
            color: #333;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        .quantity-controls button {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-controls button:hover {
            opacity: 0.8;
        }

        .quantity-controls span {
            min-width: 20px;
            text-align: center;
        }

        .summary-totals {
            border-top: 1px solid #eee;
            padding-top: 1rem;
        }

        .summary-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .summary-line.total {
            border-top: 2px solid #ff9700;
            padding-top: 1rem;
            margin-top: 1rem;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .checkout-button {
            background: linear-gradient(135deg, #ff9700, #ff7700);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .checkout-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #ff7700, #ff5500);
            box-shadow: 0 6px 20px rgba(255, 151, 0, 0.4);
        }

        .checkout-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Enhanced date input styling */

        input[type="date"] {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            width: 100%;
        }

        input[type="date"]:focus {
            outline: none;
            border-color: #ff9700;
            box-shadow: 0 0 0 3px rgba(255, 151, 0, 0.1);
        }

        input[type="date"]:invalid {
            border-color: #dc3545;
        }

        .date-help-text {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-help-text i {
            color: #ff9700;
        }

        .order-notice-checkout {
            background: linear-gradient(135deg, #fff3cd, #fff8e1);
            border: 2px solid #ff9700;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
        }

        .order-notice-checkout strong {
            color: #ff9700;
        }

        .delivery-option {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .delivery-option strong {
            color: #28a745;
        }

        .delivery-fee {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .order-type-label {
            transition: all 0.3s ease;
        }

        .order-type-label:hover:not([style*="opacity: 0.5"]) {
            border-color: #ff9700 !important;
            background-color: #fff9f0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 151, 0, 0.2);
        }

        .order-type-label input[type="radio"]:checked+i+span {
            color: #ff9700;
            font-weight: bold;
        }

        .order-type-label input[type="radio"]:checked {
            accent-color: #ff9700;
        }

        /* Delivery-specific styling */

        .order-type-label input[value="delivery"]:checked+i+span {
            color: #28a745 !important;
        }

        .order-type-label input[value="delivery"]:checked {
            accent-color: #28a745 !important;
        }

        .order-type-label:hover:not([style*="opacity: 0.5"]) input[value="delivery"]:not(:checked) {
            border-color: #28a745 !important;
            background-color: #f0f8f0;
        }

        /* Auto-check notice styling */

        .auto-check-notice {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Step-by-Step Checkout Styles */

        .checkout-progress {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
            padding: 0 1rem;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
            max-width: 200px;
        }

        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 60%;
            width: 80%;
            height: 2px;
            background: #ddd;
            z-index: 1;
        }

        .progress-step.completed:not(:last-child)::after {
            background: #ff9700;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .progress-step.active .step-number {
            background: #ff9700;
            color: white;
        }

        .progress-step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .step-title {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
            font-weight: 500;
        }

        .progress-step.active .step-title {
            color: #ff9700;
            font-weight: bold;
        }

        .progress-step.completed .step-title {
            color: #28a745;
        }

        .checkout-step {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .checkout-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile checkout - show only current step */

        @media screen and (max-width: 767px) {
            .checkout-progress {
                display: flex;
                justify-content: center;
                margin-bottom: 2rem;
            }

            .progress-step {
                display: none;
                /* Hide all progress steps by default */
            }

            .progress-step.active {
                display: flex;
                /* Show only the current active step */
            }

            .progress-step:not(:last-child)::after {
                display: none;
                /* Hide connecting lines on mobile */
            }

            .checkout-step {
                display: none !important;
            }

            .checkout-step.active {
                display: block !important;
            }
        }

        .step-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .step-header h3 {
            color: #ff9700;
            margin-bottom: 0.5rem;
            font-family: var(--second-font);
        }

        .step-description {
            color: #666;
            font-size: 1rem;
            margin: 0;
        }

        .step-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            gap: 1rem;
        }

        .step-actions .next-step {
            margin-left: auto;
        }

        .step-actions .prev-step {
            margin-right: auto;
        }

        .step-button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .step-button.prev-step {
            background: #6c757d;
            color: white;
        }

        .step-button.prev-step:hover:not(:disabled) {
            background: #5a6268;
        }

        .step-button.next-step {
            background: linear-gradient(135deg, #ff9700, #ff7700);
            color: white;
        }

        .step-button.next-step:hover:not(:disabled) {
            background: linear-gradient(135deg, #ff7700, #ff5500);
        }

        .step-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .order-summary-review {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .order-summary-review h4 {
            color: #ff9700;
            margin-bottom: 1rem;
            font-family: var(--second-font);
        }

        .review-section {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .review-section:last-of-type {
            border-bottom: none;
        }

        .review-section h5 {
            color: #ff9700;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .review-section p {
            margin: 0.25rem 0;
            color: #666;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0.5rem 0;
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .review-totals {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e9ecef;
        }

        .review-line {
            display: flex;
            justify-content: space-between;
            margin: 0.5rem 0;
        }

        .review-line.total {
            font-size: 1.1rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e9ecef;
        }

        .order-type-label input[disabled] {
            cursor: not-allowed;
        }

        .location-selection-hint {
            transition: display 0.3s ease;
        }

        @media screen and (max-width: 968px) {
            .checkout-content {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .location-options {
                grid-template-columns: 1fr;
            }

            .checkout-progress {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .progress-step {
                flex: 1;
                min-width: 120px;
            }

            .step-title {
                font-size: 0.8rem;
            }

            .step-actions {
                flex-direction: column;
                gap: 1rem;
            }

            .step-button {
                min-width: auto;
                width: 100%;
            }
        }
    </style>

    <!--=============== JS ===============-->
    <script>
        const loaderCss = '<style>html.page-loading body>*:not(#page-loader){visibility:hidden;opacity:0}#page-loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#ffffff;z-index:10000}#page-loader .spinner{width:48px;height:48px;border:5px solid #f3f3f3;border-top:5px solid #ff9700;border-radius:50%;animation:pl-spin 1s linear infinite}@keyframes pl-spin{to{transform:rotate(360deg)}}</style>';
        document.write(loaderCss + '<div id="page-loader"><div class="spinner"></div></div>');
        document.documentElement.classList.add('page-loading');

        // Remove loading when page is fully loaded
        window.addEventListener('load', () => {
            document.documentElement.classList.remove('page-loading');
            const loader = document.getElementById('page-loader');
            if (loader) {
                loader.classList.add('hidden');
                setTimeout(() => loader.remove(), 600);
            }
        });
    </script>
    <script type="module" src="assets/js/main.js"></script>

    <!-- Google Places API for Address Autocomplete -->
    <!-- Enable the Places API in your Google Cloud Console -->
    <script>
        // Dynamically load Google Maps API with key from environment variable
        (async function loadGoogleMapsAPI() {
            try {
                const response = await fetch('/.netlify/functions/get-maps-api-key');
                const data = await response.json();

                if (data.apiKey) {
                    const script = document.createElement('script');
                    // Load the new Places API (v=beta) which includes PlaceAutocompleteElement
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${data.apiKey}&libraries=places&loading=async`;
                    script.async = true;
                    script.defer = true;
                    script.onload = () => {
                        console.log('Google Places API loaded');
                        if (window.checkoutPage) {
                            window.checkoutPage.initializeAddressAutocomplete();
                        } else {
                            window.googleMapsApiLoaded = true;
                        }
                    };
                    document.head.appendChild(script);
                } else {
                    console.error('Failed to load Google Maps API key');
                }
            } catch (error) {
                console.error('Error loading Google Maps API key:', error);
            }
        })();
    </script>

    <title>Checkout - Pressed By J & H</title>

    <!--=============== SEO META TAGS ===============-->
    <meta name="description"
        content="Complete your order for premium cold-pressed juices at Pressed By J & H. Secure checkout with pickup and delivery options available. Fresh, organic juices delivered to your door.">
    <meta name="keywords"
        content="checkout, order juice, cold-pressed juice delivery, juice pickup, secure payment, fresh juice order, organic juice delivery">

    <!-- Open Graph meta tags -->
    <meta property="og:title" content="Checkout - Pressed By J & H">
    <meta property="og:description"
        content="Complete your order for premium cold-pressed juices. Secure checkout with pickup and delivery options available. Fresh, organic juices delivered to your door.">
    <meta property="og:image" content="https://siponpressed.com/assets/img/og-images/juice-og-image.png">
    <meta property="og:url" content="https://siponpressed.com/checkout">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Pressed By J & H">

    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Checkout - Pressed By J & H">
    <meta name="twitter:description"
        content="Complete your order for premium cold-pressed juices. Secure checkout with pickup and delivery options available.">
    <meta name="twitter:image" content="https://siponpressed.com/assets/img/og-images/juice-og-image.png">

    <!-- Additional SEO meta tags -->
    <meta name="robots" content="noindex, nofollow">
    <meta name="author" content="Pressed By J & H">
    <link rel="canonical" href="https://siponpressed.com/checkout">
</head>

<body>
    <main class="main">
        <div class="background-shapes">
            <div class="home__shape-small"></div>
            <div class="home__shape-big"></div>
            <img src="/assets/img/shape-bg.png" alt="" class="home__shape-bg">
        </div>

        <div class="checkout-container">
            <div class="order-notice-checkout">
                <strong><i class="ri-shopping-cart-line"></i> ORDER OPTIONS</strong> - Choose pickup or delivery
                (delivery available within 30 miles of either store)
            </div>

            <!-- Progress Steps -->
            <div class="checkout-progress">
                <div class="progress-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-title">Location & Order Type</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">Delivery Info</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">Date & Time</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-title">Contact Info</div>
                </div>
                <div class="progress-step" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-title">Review & Pay</div>
                </div>
            </div>

            <div class="checkout-content">
                <div class="checkout-form">
                    <h2 style="color: #ff9700; margin-bottom: 2rem; font-family: var(--second-font);">
                        <i class="ri-shopping-cart-line"></i> Complete Your Order
                    </h2>

                    <!-- Step 1: Location & Order Type -->
                    <div class="checkout-step active" id="step1">
                        <div class="step-header">
                            <h3><i class="ri-map-pin-line"></i> Step 1: Select Location & Order Type</h3>
                            <p class="step-description">Choose your preferred location and whether you'd like pickup or
                                delivery.
                            </p>
                        </div>
                        <div class="form-section">
                            <div class="location-options" id="locationOptions">
                                <!-- Locations will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="step-actions">
                            <button type="button" class="step-button next-step" id="step1Next"
                                disabled>Continue</button>
                        </div>
                    </div>

                    <!-- Step 2: Delivery Information -->
                    <div class="checkout-step" id="step2" style="display: none;">
                        <div class="step-header">
                            <h3><i class="ri-truck-line"></i> Step 2: Delivery Information</h3>
                            <p class="step-description">Enter your delivery address and verify it's within our delivery
                                zone.
                            </p>
                        </div>
                        <div class="form-section" id="deliverySection">
                            <div class="form-group">
                                <label for="deliveryAddress">Delivery Address:</label>
                                <input type="text" id="deliveryAddress" name="deliveryAddress"
                                    placeholder="Start typing your address...">
                                <div class="auto-check-notice" id="autocompleteHint"
                                    style="font-size: 0.8rem; color: #666; margin-top: 0.5rem; font-style: italic;">
                                    <i class="ri-information-line"></i> Loading address autocomplete...
                                </div>
                            </div>
                            <!-- City and ZIP fields - hidden by default, shown only if autocomplete fails -->
                            <div class="form-group" id="manualAddressFields" style="display: none; gap: 1rem;">
                                <div style="flex: 2;">
                                    <label for="deliveryCity">City:</label>
                                    <input type="text" id="deliveryCity" name="deliveryCity" placeholder="Enter city">
                                </div>
                                <div style="flex: 1;">
                                    <label for="deliveryZip">ZIP Code:</label>
                                    <input type="text" id="deliveryZip" name="deliveryZip" placeholder="Enter ZIP">
                                </div>
                            </div>
                            <div id="deliveryZoneMessage"
                                style="display: none; margin: 1rem 0rem; padding: 1rem; border-radius: 8px; font-weight: bold;">
                            </div>
                            <div class="delivery-option">
                                <strong style="color: #28a745;"><i class="ri-truck-line"></i> Delivery
                                    Available</strong>
                                <div class="delivery-fee">Delivery fee: $7.00 (within 30 miles of either store)</div>
                                <div class="free-shipping-notice"
                                    style="color: #ff9700; font-weight: bold; margin-top: 0.5rem;">
                                    <i class="ri-gift-line"></i> FREE shipping on orders $50+
                                </div>
                            </div>
                        </div>
                        <div class="step-actions">
                            <button type="button" class="step-button prev-step" id="step2Prev">Back to Location</button>
                            <button type="button" class="step-button next-step" id="step2Next" disabled>Continue to Date
                                Selection</button>
                        </div>
                    </div>

                    <!-- Step 3: Date Selection -->
                    <div class="checkout-step" id="step3" style="display: none;">
                        <div class="step-header">
                            <h3><i class="ri-calendar-line"></i> Step 3: Select Date</h3>
                            <p class="step-description">Choose your preferred pickup or delivery date.</p>
                        </div>
                        <div class="form-section">
                            <div class="form-group">
                                <label for="pickupDate">Choose your preferred date:</label>
                                <input type="date" id="pickupDate" name="pickupDate" required>
                                <div class="date-help-text"
                                    style="font-size: 0.875rem; color: #666; margin-top: 0.5rem;">
                                    <i class="ri-information-line"></i>
                                    <span id="location-hours-info">Select a location first to see available dates</span>
                                </div>
                            </div>
                        </div>
                        <div class="step-actions">
                            <button type="button" class="step-button prev-step" id="step3Prev">Back to Delivery
                                Info</button>
                            <button type="button" class="step-button next-step" id="step3Next" disabled>Continue to
                                Contact Info</button>
                        </div>
                    </div>

                    <!-- Step 4: Contact Information -->
                    <div class="checkout-step" id="step4" style="display: none;">
                        <div class="step-header">
                            <h3><i class="ri-user-line"></i> Step 4: Contact Information</h3>
                            <p class="step-description">Provide your contact details for order confirmation.</p>
                        </div>
                        <div class="form-section">
                            <div class="form-group">
                                <label for="customerName">Full Name:</label>
                                <input type="text" id="customerName" name="customerName" required>
                            </div>
                            <div class="form-group">
                                <label for="customerPhone">Phone Number:</label>
                                <input type="tel" id="customerPhone" name="customerPhone" required>
                            </div>
                        </div>
                        <div class="step-actions">
                            <button type="button" class="step-button prev-step" id="step4Prev">Back to Date
                                Selection</button>
                            <button type="button" class="step-button next-step" id="step4Next" disabled>Review &
                                Pay</button>
                        </div>
                    </div>

                    <!-- Step 5: Review & Pay -->
                    <div class="checkout-step" id="step5" style="display: none;">
                        <div class="step-header">
                            <h3><i class="ri-checkbox-circle-line"></i> Step 5: Review & Pay</h3>
                            <p class="step-description">Review your order details in the expanded order summary and
                                proceed to payment.</p>
                        </div>
                        <div class="form-section">
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <i class="ri-arrow-right-line"
                                    style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                <p>Your order summary has been expanded to show all details. Please review everything
                                    carefully before proceeding to payment.</p>
                            </div>
                        </div>
                        <div class="step-actions">
                            <button type="button" class="step-button prev-step" id="step5Prev">Back to Contact
                                Info</button>
                        </div>
                    </div>
                </div>

                <div class="order-summary">
                    <div class="summary-header">
                        <i class="ri-file-list-line"></i>
                        <h3>Order Summary</h3>
                    </div>

                    <div class="order-items" id="orderItems">
                        <!-- Items will be populated by JavaScript -->
                    </div>

                    <div class="summary-totals">
                        <div class="summary-line">
                            <span>Subtotal:</span>
                            <span id="subtotalAmount">$0.00</span>
                        </div>
                        <div class="summary-line total">
                            <span>Total:</span>
                            <span id="totalAmount">$0.00</span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!--=============== MAIN JS ===============-->
    <script src="/assets/js/juices-database.js"></script>
    <script src="/assets/js/locations-database.js"></script>
    <script src="/assets/js/cart.js"></script>
    <script src="/assets/js/components/footer.js"></script>
    <script>
        // Checkout page functionality
        class CheckoutPage {
            constructor() {
                this.selectedLocation = null;
                this.orderType = 'pickup'; // 'pickup' or 'delivery'
                this.deliveryZoneValid = false; // Track if delivery address is in zone
                this.currentStep = 1; // Track current step
                this.cart = window.cart || new Cart();
                this.autocomplete = null; // Store autocomplete instance
                this.addressSelectedFromAutocomplete = false; // Track if address was selected from Google Places
                this.deliveryCity = ''; // Store city from autocomplete
                this.deliveryZip = ''; // Store ZIP from autocomplete
                this.init();
            }

            init() {
                this.populateLocations();
                this.setupLocationSelector();
                this.setupDatePicker();
                this.setupFormValidation();
                this.setupDeliveryZoneCheck();
                this.setupStepNavigation();
                this.populateOrderSummary();
                this.setupCheckoutButton();
                this.setupCartChangeListener();
            }

            // Helper method to get delivery address value (handles PlaceAutocompleteElement)
            getDeliveryAddressValue() {
                // If autocomplete is active, get value from the autocomplete element
                if (this.autocomplete) {
                    // PlaceAutocompleteElement has a value property
                    return this.autocomplete.value?.trim() || '';
                }
                // Otherwise, get from the regular input field (fallback mode)
                const addressInput = document.getElementById('deliveryAddress');
                return addressInput?.value?.trim() || '';
            }

            populateLocations() {
                const locationOptionsContainer = document.getElementById('locationOptions');
                const activeLocations = getActiveLocations();
                const totalItems = this.cart.getTotalItems();
                const hasMinimumForDelivery = totalItems >= 5;

                let locationsHTML = '';
                activeLocations.forEach(location => {
                    const todaysHours = getTodaysHours(location.slug);
                    const formattedHours = getFormattedHours(location);
                    const deliveryAvailable = isDeliveryAvailable(location.slug);
                    const deliveryFee = getDeliveryFee(location.slug);

                    locationsHTML += `
                        <div class="location-card" data-location="${location.slug}" data-location-id="${location.id}">
                            <h4>${location.name}</h4>
                            <p style="font-weight: bold;">${location.fullLocation}</p>
                            <p style="color: #666; margin-top: 0.5rem;">${location.description}</p>
                            
                            <div class="location-details">
                                <p><strong>Address:</strong><br>${location.address}</p>
                                <p><strong>Phone:</strong> <span class="phone-number">${location.contactPhone}</span></p>
                                <p><strong>Today's Hours:</strong> ${todaysHours}</p>
                                <div class="hours-display">
                                    <strong>Full Schedule:</strong><br>
                                    ${formattedHours.split('\n').join('<br>')}
                                </div>
                                ${location.specialInstructions ? `
                                    <div style="margin-top: 1rem; padding: 0.5rem; background: #fff3cd; border-radius: 4px; border-left: 4px solid #ff9700;">
                                        <strong style="color: #ff9700;"><i class="ri-file-list-line"></i> Ordering Info</strong><br>
                                        <small>${location.specialInstructions}</small>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="order-type-selection" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                                <label style="display: block; margin-bottom: 1rem; font-weight: bold; text-align: center;">Order Type:</label>
                                <div style="display: flex; gap: 1.5rem; justify-content: center; margin-bottom: 0.5rem;">
                                    <label style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem; cursor: pointer; opacity: 0.5; padding: 1rem; border: 2px solid #ddd; border-radius: 8px; min-width: 120px; transition: all 0.3s ease;" class="order-type-label">
                                        <input type="radio" name="orderType_${location.slug}" value="pickup" checked disabled style="margin: 0;">
                                        <i class="ri-store-2-line" style="font-size: 1.5rem; color: #ff9700;"></i>
                                        <span style="font-weight: bold;">Pickup</span>
                                    </label>
                                    ${deliveryAvailable ? `
                                        <label style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem; cursor: ${hasMinimumForDelivery ? 'pointer' : 'not-allowed'}; opacity: ${hasMinimumForDelivery ? '0.5' : '0.3'}; padding: 1rem; border: 2px solid #ddd; border-radius: 8px; min-width: 120px; transition: all 0.3s ease;" class="order-type-label" title="${!hasMinimumForDelivery ? 'Delivery requires 5 bottles minimum' : ''}">
                                            <input type="radio" name="orderType_${location.slug}" value="delivery" disabled style="margin: 0;">
                                            <i class="ri-truck-line" style="font-size: 1.5rem; color: #28a745;"></i>
                                            <span style="font-weight: bold;">Delivery</span>
                                            ${!hasMinimumForDelivery ? '<small style="font-size: 0.7rem; color: #dc3545; text-align: center;">(5 bottle minimum)</small>' : ''}
                                        </label>
                                    ` : ''}
                                </div>
                                <div class="location-selection-hint" style="font-size: 0.8rem; color: #666; margin-top: 0.5rem; font-style: italic; text-align: center;">
                                    <i class="ri-information-line"></i> Select a location above to choose order type
                                    ${!hasMinimumForDelivery && deliveryAvailable ? '<br><span style="color: #dc3545;"><i class="ri-error-warning-line"></i> Delivery requires 5 bottles minimum</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                locationOptionsContainer.innerHTML = locationsHTML;
            }

            setupLocationSelector() {
                const locationCards = document.querySelectorAll('.location-card');
                locationCards.forEach(card => {
                    // Handle location card selection
                    card.addEventListener('click', (e) => {
                        // Don't trigger if clicking on radio buttons
                        if (e.target.type === 'radio') return;

                        // Remove selected class from all cards
                        locationCards.forEach(c => c.classList.remove('selected'));
                        // Add selected class to clicked card
                        card.classList.add('selected');
                        this.selectedLocation = card.dataset.location;

                        // Reset order type to pickup when switching locations
                        this.orderType = 'pickup';

                        // Enable radio buttons for the selected location and disable others
                        const allRadioButtons = document.querySelectorAll('input[type="radio"]');
                        const allOrderTypeLabels = document.querySelectorAll('.order-type-label');
                        const allLocationHints = document.querySelectorAll('.location-selection-hint');
                        const totalItems = this.cart.getTotalItems();
                        const hasMinimumForDelivery = totalItems >= 5;

                        allRadioButtons.forEach(radio => {
                            const isCurrentLocation = radio.name === `orderType_${this.selectedLocation}`;
                            const isDeliveryRadio = radio.value === 'delivery';
                            const deliveryAvailable = isDeliveryAvailable(this.selectedLocation);

                            // Disable delivery radio if not enough items or not available
                            const shouldDisableDelivery = isDeliveryRadio && (!hasMinimumForDelivery || !deliveryAvailable);

                            radio.disabled = !isCurrentLocation || shouldDisableDelivery;
                            const shouldBeChecked = isCurrentLocation && radio.value === 'pickup';
                            radio.checked = shouldBeChecked;

                            // If we're checking a radio button, trigger the change event
                            if (shouldBeChecked && isCurrentLocation) {
                                this.orderType = 'pickup';
                                this.updateDeliverySection();
                                this.updateLocationHoursInfo();
                                this.populateOrderSummary();
                                this.validateForm();
                            }
                        });

                        allOrderTypeLabels.forEach(label => {
                            const isCurrentLocation = label.querySelector('input').name === `orderType_${this.selectedLocation}`;
                            const isDeliveryLabel = label.querySelector('input').value === 'delivery';
                            const deliveryAvailable = isDeliveryAvailable(this.selectedLocation);
                            const shouldDisableDelivery = isDeliveryLabel && (!hasMinimumForDelivery || !deliveryAvailable);

                            if (isCurrentLocation) {
                                label.style.opacity = shouldDisableDelivery ? '0.3' : '1';
                                label.style.cursor = shouldDisableDelivery ? 'not-allowed' : 'pointer';
                                label.style.borderColor = '#ddd';
                                label.style.backgroundColor = 'transparent';
                            } else {
                                label.style.opacity = '0.5';
                                label.style.cursor = 'not-allowed';
                            }
                        });

                        allLocationHints.forEach(hint => {
                            const isCurrentLocation = hint.closest('.location-card').dataset.location === this.selectedLocation;
                            hint.style.display = isCurrentLocation ? 'none' : 'block';
                        });

                        // Update date picker with location-specific restrictions
                        this.updateDatePickerForLocation();
                        // Update delivery section visibility
                        this.updateDeliverySection();
                        // Update location hours info
                        this.updateLocationHoursInfo();
                        this.validateForm();
                        // Enable step 1 next button
                        this.updateStepButtons();
                        this.updateBackButtonText();
                        this.updateStepHeaders();
                        this.updateProgressIndicator(this.currentStep);
                    });

                    // Handle order type radio button changes using event delegation
                    card.addEventListener('change', (e) => {
                        if (e.target.type === 'radio' && e.target.name.startsWith('orderType_')) {
                            if (e.target.checked && !e.target.disabled) {
                                this.orderType = e.target.value;
                                this.updateDeliverySection();
                                this.updateLocationHoursInfo();
                                this.populateOrderSummary();
                                this.validateForm();
                                this.updateStepButtons();
                                this.updateBackButtonText();
                                this.updateStepHeaders();
                                this.updateProgressIndicator(this.currentStep);
                            }
                        }
                    });
                });
            }

            updateDeliverySection() {
                const deliverySection = document.getElementById('deliverySection');
                const totalItems = this.cart.getTotalItems();
                const hasMinimumForDelivery = totalItems >= 5;

                if (this.orderType === 'delivery' && this.selectedLocation && isDeliveryAvailable(this.selectedLocation) && hasMinimumForDelivery) {
                    deliverySection.style.display = 'block';
                } else {
                    deliverySection.style.display = 'none';
                    // Reset delivery zone validation when hiding section
                    this.deliveryZoneValid = false;
                    this.hideDeliveryZoneMessage();
                }
            }

            updateStepButtons() {
                // Update step 1 next button
                const step1Next = document.getElementById('step1Next');
                if (step1Next) {
                    step1Next.disabled = !this.selectedLocation;
                    // Update button text based on order type
                    if (this.selectedLocation) {
                        const location = getLocationBySlug(this.selectedLocation);
                        if (location && isDeliveryAvailable(this.selectedLocation)) {
                            step1Next.textContent = this.orderType === 'delivery' ? 'Continue to Delivery Info' : 'Continue to Date Selection';
                        } else {
                            step1Next.textContent = 'Continue to Date Selection';
                        }
                    } else {
                        step1Next.textContent = 'Continue';
                    }
                }

                // Update step 2 next button (only if delivery is selected)
                const step2Next = document.getElementById('step2Next');
                if (step2Next) {
                    step2Next.textContent = 'Continue to Date Selection';
                    if (this.orderType === 'delivery' && this.selectedLocation && isDeliveryAvailable(this.selectedLocation)) {
                        const deliveryAddress = this.getDeliveryAddressValue();
                        const deliveryCity = document.getElementById('deliveryCity')?.value?.trim() || '';
                        const deliveryZip = document.getElementById('deliveryZip')?.value?.trim() || '';
                        step2Next.disabled = !deliveryAddress || !deliveryCity || !deliveryZip || !this.deliveryZoneValid;
                    } else {
                        step2Next.disabled = false; // Skip delivery step for pickup
                    }
                }

                // Update step 3 next button text
                const step3Next = document.getElementById('step3Next');
                if (step3Next) {
                    step3Next.textContent = 'Continue to Contact Info';
                }

                // Update step 4 next button text
                const step4Next = document.getElementById('step4Next');
                if (step4Next) {
                    step4Next.textContent = 'Review & Pay';
                }

                // Update step 3 next button validation
                if (step3Next) {
                    const date = this.getSelectedPickupDate();
                    step3Next.disabled = !date || !this.isValidPickupDate(date);
                }

                // Update step 4 next button validation
                if (step4Next) {
                    const name = document.getElementById('customerName').value.trim();
                    const phone = document.getElementById('customerPhone').value.trim();
                    step4Next.disabled = !name || !phone;
                }

                // Update the final payment button (only when on step 5)
                if (this.currentStep === 5) {
                    const name = document.getElementById('customerName').value.trim();
                    const phone = document.getElementById('customerPhone').value.trim();
                    const date = this.getSelectedPickupDate();
                    const location = this.selectedLocation;
                    const totalItems = this.cart.getTotalItems();

                    let isFormValid = name && phone && date && location && Object.keys(this.cart.items).length > 0;
                    const isDateValid = !date || !location || this.isValidPickupDate(date);

                    // Check delivery minimum requirement
                    const hasMinimumForDelivery = totalItems >= 5;
                    if (this.orderType === 'delivery' && !hasMinimumForDelivery) {
                        isFormValid = false;
                    }

                    // If delivery is selected, validate delivery fields and zone
                    if (this.orderType === 'delivery' && location && isDeliveryAvailable(location)) {
                        const deliveryAddress = this.getDeliveryAddressValue();
                        const deliveryCity = document.getElementById('deliveryCity')?.value?.trim() || '';
                        const deliveryZip = document.getElementById('deliveryZip')?.value?.trim() || '';
                        isFormValid = isFormValid && deliveryAddress && deliveryCity && deliveryZip && this.deliveryZoneValid;
                    }

                    const isValid = isFormValid && isDateValid;

                    // Update the payment button in the order summary
                    const completeOrderButton = document.querySelector('#completeOrderButtonFromSummary');
                    if (completeOrderButton) {
                        completeOrderButton.disabled = !isValid;

                        // Add tooltip for disabled state
                        if (!isValid && this.orderType === 'delivery' && !hasMinimumForDelivery) {
                            completeOrderButton.title = 'Delivery requires 5 bottles minimum';
                        } else {
                            completeOrderButton.title = '';
                        }
                    }
                }

                // Auto-scroll to next step button when step is completed (for mobile UX)
                this.autoScrollToNextButton();
            }

            autoScrollToNextButton() {
                // Only auto-scroll if we're on mobile (767px and below)
                if (window.innerWidth > 767) return;

                // Find the next button for the current step
                let nextButton = null;

                // Map step numbers to their next button IDs
                const nextButtonMap = {
                    1: 'step1Next',
                    2: 'step2Next',
                    3: 'step3Next',
                    4: 'step4Next',
                    5: 'completeOrderButtonFromSummary'
                };

                const buttonId = nextButtonMap[this.currentStep];
                if (buttonId) {
                    nextButton = document.getElementById(buttonId);
                }

                // If no next button found, try to find any step button in the current step
                if (!nextButton) {
                    const currentStepElement = document.getElementById(`step${this.currentStep}`);
                    if (currentStepElement) {
                        // Look for any button with 'step-button' class or 'Next' text
                        nextButton = currentStepElement.querySelector('.step-button:not(.prev-step)') ||
                            currentStepElement.querySelector('button:not(.prev-step)');
                    }
                }

                // Scroll to the button if found and it's enabled
                if (nextButton && !nextButton.disabled) {
                    setTimeout(() => {
                        nextButton.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center',
                            inline: 'nearest'
                        });
                    }, 300); // Small delay to allow for any UI updates
                }
            }

            updateBackButtonText() {
                // Update step 3 back button text based on order type
                const step3Prev = document.getElementById('step3Prev');
                if (step3Prev) {
                    step3Prev.textContent = this.orderType === 'delivery' ? 'Back to Delivery Info' : 'Back to Location';
                }
            }

            updateStepHeaders() {
                // Update step headers to show correct step numbers
                const step1Header = document.querySelector('#step1 .step-header h3');
                const step2Header = document.querySelector('#step2 .step-header h3');
                const step3Header = document.querySelector('#step3 .step-header h3');
                const step4Header = document.querySelector('#step4 .step-header h3');
                const step5Header = document.querySelector('#step5 .step-header h3');

                if (this.orderType === 'pickup') {
                    // For pickup: 1, 2, 3, 4 (skip delivery step)
                    if (step1Header) step1Header.innerHTML = '<i class="ri-map-pin-line"></i> Step 1: Select Location & Order Type';
                    if (step2Header) step2Header.innerHTML = '<i class="ri-truck-line"></i> Step 2: Delivery Information';
                    if (step3Header) step3Header.innerHTML = '<i class="ri-calendar-line"></i> Step 2: Select Date';
                    if (step4Header) step4Header.innerHTML = '<i class="ri-user-line"></i> Step 3: Contact Information';
                    if (step5Header) step5Header.innerHTML = '<i class="ri-checkbox-circle-line"></i> Step 4: Review & Pay';
                } else {
                    // For delivery: 1, 2, 3, 4, 5 (full flow)
                    if (step1Header) step1Header.innerHTML = '<i class="ri-map-pin-line"></i> Step 1: Select Location & Order Type';
                    if (step2Header) step2Header.innerHTML = '<i class="ri-truck-line"></i> Step 2: Delivery Information';
                    if (step3Header) step3Header.innerHTML = '<i class="ri-calendar-line"></i> Step 3: Select Date';
                    if (step4Header) step4Header.innerHTML = '<i class="ri-user-line"></i> Step 4: Contact Information';
                    if (step5Header) step5Header.innerHTML = '<i class="ri-checkbox-circle-line"></i> Step 5: Review & Pay';
                }
            }

            setupDeliveryZoneCheck() {
                // Auto-check is now handled in setupFormValidation
                // This method is kept for compatibility but functionality moved
            }

            async checkDeliveryZone() {
                const zipCode = document.getElementById('deliveryZip')?.value?.trim() || '';
                const city = document.getElementById('deliveryCity')?.value?.trim() || '';
                const address = this.getDeliveryAddressValue();

                if (!zipCode || !city || !address) {
                    this.showDeliveryZoneMessage('Please fill in all delivery address fields before checking the delivery zone.', 'error');
                    return;
                }

                // Show loading state
                this.showDeliveryZoneMessage('  Validating address and checking delivery zone...', 'info');

                try {
                    // Enhanced validation with multiple checks
                    const validationResult = await this.validateDeliveryAddress(address, city, zipCode);

                    if (validationResult.isValid) {
                        this.deliveryZoneValid = true;
                        this.showDeliveryZoneMessage('  Great! Your address is within our 30-mile delivery zone.', 'success');
                    } else {
                        this.deliveryZoneValid = false;
                        this.showDeliveryZoneMessage(`  ${validationResult.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Error validating delivery zone:', error);
                    // Fallback to ZIP code validation
                    this.fallbackZipValidation(zipCode);
                }

                this.validateForm();
                this.updateStepButtons();
            }

            async validateDeliveryAddress(address, city, zipCode) {
                // First, validate ZIP code format and range
                const zipValidation = this.validateZipCode(zipCode);
                if (!zipValidation.isValid) {
                    return zipValidation;
                }

                // Then validate the full address
                const fullAddress = `${address}, ${city}, NJ ${zipCode}`;

                try {
                    // Use a free geocoding service for address validation
                    // Note: Replace with your preferred geocoding service
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`);

                    if (!response.ok) {
                        // If geocoding fails, fall back to ZIP validation
                        return this.validateZipCode(zipCode);
                    }

                    const data = await response.json();

                    if (!data || data.length === 0) {
                        return {
                            isValid: false,
                            message: 'Address not found. Please check your address and try again.'
                        };
                    }

                    // Check distance from both stores (Blackwood and Woodbury)
                    const distanceBlackwood = this.calculateDistanceFromStore(data[0].lat, data[0].lon, 39.8021, -75.0649);
                    const distanceWoodbury = this.calculateDistanceFromStore(data[0].lat, data[0].lon, 39.8187, -75.16145);

                    const nearestStore = distanceBlackwood < distanceWoodbury ? 'Blackwood' : 'Woodbury';
                    const minDistance = Math.min(distanceBlackwood, distanceWoodbury);

                    if (minDistance <= 30) {
                        return {
                            isValid: true,
                            message: `Address is within delivery zone (${Math.round(minDistance)} miles from ${nearestStore}).`
                        };
                    } else {
                        return {
                            isValid: false,
                            message: `Address is ${Math.round(minDistance)} miles from the nearest store. We only deliver within 30 miles of our locations.`
                        };
                    }
                } catch (error) {
                    console.error('Geocoding error:', error);
                    // Fallback to ZIP validation
                    return this.validateZipCode(zipCode);
                }
            }

            validateZipCode(zipCode) {
                const userZip = parseInt(zipCode);
                const blackwoodZip = 8021;

                if (isNaN(userZip) || zipCode.length !== 5) {
                    return {
                        isValid: false,
                        message: 'Please enter a valid 5-digit ZIP code.'
                    };
                }

                // Check if ZIP is in reasonable range (within ~30 miles of either store)
                const zipDifference = Math.abs(userZip - blackwoodZip);

                if (zipDifference <= 50) { // Allow some flexibility in ZIP range
                    return {
                        isValid: true,
                        message: 'ZIP code is within delivery zone.'
                    };
                } else {
                    return {
                        isValid: false,
                        message: 'ZIP code is outside our 30-mile delivery zone from our locations.'
                    };
                }
            }

            calculateDistanceFromStore(lat, lon, storeLat, storeLng) {
                return this.calculateDistance(storeLat, storeLng, parseFloat(lat), parseFloat(lon));
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 3959; // Earth's radius in miles
                const dLat = this.toRadians(lat2 - lat1);
                const dLon = this.toRadians(lon2 - lon1);
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(this.toRadians(lat1)) * Math.cos(this.toRadians(lat2)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            toRadians(degrees) {
                return degrees * (Math.PI / 180);
            }

            fallbackZipValidation(zipCode) {
                const validation = this.validateZipCode(zipCode);
                this.deliveryZoneValid = validation.isValid;
                this.showDeliveryZoneMessage(validation.isValid ? '  Address validated (ZIP code check).' : `  ${validation.message}`, validation.isValid ? 'success' : 'error');
                this.updateStepButtons();
                return validation.isValid;
            }

            showDeliveryZoneMessage(message, type) {
                const messageDiv = document.getElementById('deliveryZoneMessage');
                if (messageDiv) {
                    messageDiv.textContent = message;
                    messageDiv.style.display = 'block';

                    if (type === 'success') {
                        messageDiv.style.backgroundColor = '#d4edda';
                        messageDiv.style.color = '#155724';
                        messageDiv.style.border = '1px solid #c3e6cb';
                    } else if (type === 'error') {
                        messageDiv.style.backgroundColor = '#f8d7da';
                        messageDiv.style.color = '#721c24';
                        messageDiv.style.border = '1px solid #f5c6cb';
                    } else if (type === 'info') {
                        messageDiv.style.backgroundColor = '#d1ecf1';
                        messageDiv.style.color = '#0c5460';
                        messageDiv.style.border = '1px solid #bee5eb';
                    }
                }
            }

            hideDeliveryZoneMessage() {
                const messageDiv = document.getElementById('deliveryZoneMessage');
                if (messageDiv) {
                    messageDiv.style.display = 'none';
                }
            }

            autoCheckDeliveryZone() {
                // Only auto-check if we're on step 2 and delivery is selected
                if (this.currentStep !== 2 || this.orderType !== 'delivery') return;

                const deliveryAddress = this.getDeliveryAddressValue();
                const deliveryCity = document.getElementById('deliveryCity')?.value?.trim() || '';
                const deliveryZip = document.getElementById('deliveryZip')?.value?.trim() || '';

                // Auto-check if all fields are filled
                if (deliveryAddress && deliveryCity && deliveryZip) {
                    this.checkDeliveryZone().then(() => {
                        // Update step buttons after validation is complete
                        this.updateStepButtons();
                    });
                }
            }

            async initializeAddressAutocomplete() {
                // Initialize Google Places Autocomplete using PlaceAutocompleteElement
                // This is the recommended approach as of March 2025
                // NOTE: Requires both Places API (New) AND Maps JavaScript API to be enabled

                const addressInput = document.getElementById('deliveryAddress');
                const autocompleteHint = document.getElementById('autocompleteHint');
                const manualFields = document.getElementById('manualAddressFields');

                if (!addressInput) return;

                // Helper to show fallback UI
                const showFallbackUI = (reason = '') => {
                    console.warn('Falling back to manual address entry:', reason);
                    if (autocompleteHint) {
                        autocompleteHint.innerHTML = '<i class="ri-information-line"></i> Enter your address manually. Fill in all fields.';
                    }
                    if (manualFields) {
                        manualFields.style.display = 'flex';
                    }
                    if (addressInput) {
                        addressInput.placeholder = 'Enter street address';
                    }
                };

                // Check if Google Maps is loaded
                if (typeof google === 'undefined' || !google.maps) {
                    showFallbackUI('Google Maps API not loaded');
                    return;
                }

                try {
                    // Use the new Places API with importLibrary
                    const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");

                    // Create the PlaceAutocompleteElement web component
                    this.autocomplete = new PlaceAutocompleteElement({
                        componentRestrictions: { country: ['US'] },
                        types: ['address']
                    });

                    // Get the original input's attributes
                    const placeholder = addressInput.getAttribute('placeholder') || 'Start typing your address...';

                    // Replace the input with the autocomplete element
                    addressInput.parentNode.replaceChild(this.autocomplete, addressInput);

                    // Update the hint text
                    if (autocompleteHint) {
                        autocompleteHint.innerHTML = '<i class="ri-information-line"></i> Start typing your address and select from dropdown. City and ZIP will auto-fill.';
                    }

                    console.log('Google Places Autocomplete (PlaceAutocompleteElement) initialized successfully');

                    // Listen for place selection events
                    this.autocomplete.addEventListener('gmp-placeselect', async (event) => {
                        const place = event.place;

                        if (!place) {
                            console.error('No place details available');
                            this.addressSelectedFromAutocomplete = false;
                            return;
                        }

                        try {
                            // Fetch the place details we need
                            await place.fetchFields({
                                fields: ['addressComponents', 'location', 'formattedAddress']
                            });

                            // Mark that address was selected from autocomplete
                            this.addressSelectedFromAutocomplete = true;

                            // Parse address components
                            let streetNumber = '';
                            let route = '';
                            let city = '';
                            let state = '';
                            let zipCode = '';

                            if (place.addressComponents) {
                                place.addressComponents.forEach(component => {
                                    const types = component.types;
                                    if (types.includes('street_number')) {
                                        streetNumber = component.longText;
                                    }
                                    if (types.includes('route')) {
                                        route = component.longText;
                                    }
                                    if (types.includes('locality')) {
                                        city = component.longText;
                                    }
                                    if (types.includes('administrative_area_level_1')) {
                                        state = component.shortText;
                                    }
                                    if (types.includes('postal_code')) {
                                        zipCode = component.longText;
                                    }
                                });
                            }

                            // Store city and ZIP internally (not in visible fields since they're hidden)
                            this.deliveryCity = city;
                            this.deliveryZip = zipCode;

                            // Update hidden fields for form submission
                            const cityField = document.getElementById('deliveryCity');
                            const zipField = document.getElementById('deliveryZip');

                            if (cityField) cityField.value = city;
                            if (zipField) zipField.value = zipCode;

                            // Validate the selected address automatically
                            this.checkDeliveryZone();
                        } catch (error) {
                            console.error('Error fetching place details:', error);
                            this.addressSelectedFromAutocomplete = false;
                        }
                    });

                    // Listen for input changes to track manual edits
                    this.autocomplete.addEventListener('input', (e) => {
                        // If user manually types or edits, clear the autocomplete flag
                        this.addressSelectedFromAutocomplete = false;
                        this.deliveryZoneValid = false;

                        // Clear validation message when user starts editing
                        const messageDiv = document.getElementById('deliveryZoneMessage');
                        if (messageDiv) {
                            messageDiv.style.display = 'none';
                        }
                    });

                } catch (error) {
                    console.error('Error initializing PlaceAutocompleteElement:', error);

                    // Check if it's an API not enabled error
                    if (error.message && error.message.includes('Places API')) {
                        showFallbackUI('Places API (New) not enabled. Enable it in Google Cloud Console.');
                    } else {
                        showFallbackUI('Failed to initialize autocomplete: ' + error.message);
                    }
                }
            }

            setupStepNavigation() {
                // Step 1 navigation
                document.getElementById('step1Next').addEventListener('click', () => {
                    if (this.validateStep1()) {
                        // Skip to step 3 if pickup, otherwise go to step 2
                        const nextStep = this.orderType === 'pickup' ? 3 : 2;
                        this.goToStep(nextStep);
                    }
                });

                // Step 2 navigation
                document.getElementById('step2Prev').addEventListener('click', () => {
                    this.goToStep(1);
                });

                document.getElementById('step2Next').addEventListener('click', () => {
                    if (this.validateStep2()) {
                        this.goToStep(3);
                    }
                });

                // Step 3 navigation
                document.getElementById('step3Prev').addEventListener('click', () => {
                    // Go back to step 2 if delivery, otherwise step 1 if pickup
                    const prevStep = this.orderType === 'delivery' ? 2 : 1;
                    this.goToStep(prevStep);
                });

                document.getElementById('step3Next').addEventListener('click', () => {
                    if (this.validateStep3()) {
                        this.goToStep(4);
                    }
                });

                // Step 4 navigation
                document.getElementById('step4Prev').addEventListener('click', () => {
                    this.goToStep(3);
                });

                document.getElementById('step4Next').addEventListener('click', () => {
                    if (this.validateStep4()) {
                        this.goToStep(5);
                    }
                });

                // Step 5 navigation
                document.getElementById('step5Prev').addEventListener('click', () => {
                    this.goToStep(4);
                });
            }

            goToStep(stepNumber) {
                // Handle step skipping for pickup orders
                if (stepNumber === 2 && this.orderType === 'pickup') {
                    stepNumber = 3; // Skip delivery step for pickup
                }

                // Hide all steps
                document.querySelectorAll('.checkout-step').forEach(step => {
                    step.classList.remove('active');
                    step.style.display = 'none';
                });

                // Hide step 2 completely for pickup orders
                const step2Element = document.getElementById('step2');
                if (step2Element && this.orderType === 'pickup') {
                    step2Element.style.display = 'none';
                }

                // Show current step
                const currentStepElement = document.getElementById(`step${stepNumber}`);
                if (currentStepElement) {
                    currentStepElement.classList.add('active');
                    currentStepElement.style.display = 'block';
                }

                // Auto-scroll to the next step button after a short delay
                setTimeout(() => {
                    this.scrollToNextStepButton(stepNumber);
                }, 100);

                // Update progress indicator and step headers
                this.updateStepHeaders();
                this.updateProgressIndicator(stepNumber);

                this.currentStep = stepNumber;

                // Special handling for step 5
                if (stepNumber === 5) {
                    // Hide the checkout form
                    const checkoutForm = document.querySelector('.checkout-form');
                    if (checkoutForm) {
                        checkoutForm.style.display = 'none';
                    }

                    // Make checkout content full width
                    const checkoutContent = document.querySelector('.checkout-content');
                    if (checkoutContent) {
                        checkoutContent.classList.add('full-width');
                    }

                    // Make order summary full screen
                    const orderSummary = document.querySelector('.order-summary');
                    if (orderSummary) {
                        orderSummary.classList.add('full-screen');
                    }
                    this.populateOrderSummaryReview();
                    this.updateStepButtons(); // Update payment button state
                } else {
                    // Show the checkout form for other steps
                    const checkoutForm = document.querySelector('.checkout-form');
                    if (checkoutForm) {
                        checkoutForm.style.display = 'block';
                    }

                    // Remove full width class for other steps
                    const checkoutContent = document.querySelector('.checkout-content');
                    if (checkoutContent) {
                        checkoutContent.classList.remove('full-width');
                    }

                    // Remove full screen class for other steps
                    const orderSummary = document.querySelector('.order-summary');
                    if (orderSummary) {
                        orderSummary.classList.remove('full-screen');
                        // Remove review sections when leaving step 5
                        const reviewSections = orderSummary.querySelectorAll('.review-section');
                        reviewSections.forEach(section => section.remove());
                        // Remove back button when leaving step 5
                        const backButtonContainer = orderSummary.querySelector('.step-actions');
                        if (backButtonContainer) {
                            backButtonContainer.remove();
                        }
                    }
                }
            }

            scrollToNextStepButton(stepNumber) {
                // Find the next step button for the current step
                let nextButton = null;

                // Map step numbers to their next button IDs
                const nextButtonMap = {
                    1: 'step1Next',
                    2: 'step2Next',
                    3: 'step3Next',
                    4: 'step4Next',
                    5: 'completeOrderButtonFromSummary' // Special case for step 5
                };

                const buttonId = nextButtonMap[stepNumber];
                if (buttonId) {
                    nextButton = document.getElementById(buttonId);
                }

                // If no next button found, try to find any step button in the current step
                if (!nextButton) {
                    const currentStepElement = document.getElementById(`step${stepNumber}`);
                    if (currentStepElement) {
                        // Look for any button with 'step-button' class or 'Next' text
                        nextButton = currentStepElement.querySelector('.step-button:not(.prev-step)') ||
                            currentStepElement.querySelector('button:not(.prev-step)');
                    }
                }

                // Scroll to the button if found
                if (nextButton) {
                    nextButton.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center',
                        inline: 'nearest'
                    });
                }
            }

            updateProgressIndicator(activeStep) {
                document.querySelectorAll('.progress-step').forEach((step, index) => {
                    const stepNumber = index + 1;
                    step.classList.remove('active', 'completed');

                    // Hide step 2 for pickup orders and adjust step numbers
                    if (stepNumber === 2 && this.orderType === 'pickup') {
                        step.style.display = 'none';
                        return;
                    } else if (stepNumber === 2) {
                        step.style.display = 'flex';
                    }

                    // Update step numbers for pickup orders (skip step 2)
                    let displayStepNumber = stepNumber;
                    if (this.orderType === 'pickup' && stepNumber > 2) {
                        displayStepNumber = stepNumber - 1;
                    }

                    // Update the step number display
                    const stepNumberElement = step.querySelector('.step-number');
                    if (stepNumberElement) {
                        stepNumberElement.textContent = displayStepNumber;
                    }

                    // Update step titles for pickup orders
                    const stepTitleElement = step.querySelector('.step-title');
                    if (stepTitleElement) {
                        if (this.orderType === 'pickup') {
                            switch (displayStepNumber) {
                                case 1:
                                    stepTitleElement.textContent = 'Location & Order Type';
                                    break;
                                case 2:
                                    stepTitleElement.textContent = 'Date & Time';
                                    break;
                                case 3:
                                    stepTitleElement.textContent = 'Contact Info';
                                    break;
                                case 4:
                                    stepTitleElement.textContent = 'Review & Pay';
                                    break;
                            }
                        } else {
                            // Reset to original titles for delivery
                            switch (stepNumber) {
                                case 1:
                                    stepTitleElement.textContent = 'Location & Order Type';
                                    break;
                                case 2:
                                    stepTitleElement.textContent = 'Delivery Info';
                                    break;
                                case 3:
                                    stepTitleElement.textContent = 'Date & Time';
                                    break;
                                case 4:
                                    stepTitleElement.textContent = 'Contact Info';
                                    break;
                                case 5:
                                    stepTitleElement.textContent = 'Review & Pay';
                                    break;
                            }
                        }
                    }

                    // Handle active and completed states based on order type
                    if (this.orderType === 'pickup') {
                        // For pickup orders, adjust step numbers
                        let adjustedActiveStep = activeStep;
                        if (activeStep > 2) {
                            adjustedActiveStep = activeStep - 1;
                        }

                        if (displayStepNumber === adjustedActiveStep) {
                            step.classList.add('active');
                        } else if (displayStepNumber < adjustedActiveStep) {
                            step.classList.add('completed');
                        }
                    } else {
                        // For delivery orders, use original logic
                        if (stepNumber === activeStep) {
                            step.classList.add('active');
                        } else if (stepNumber < activeStep) {
                            step.classList.add('completed');
                        }
                    }
                });
            }

            validateStep1() {
                if (!this.selectedLocation) {
                    this.showStepError('Please select a location and order type before continuing.');
                    return false;
                }
                return true;
            }

            validateStep2() {
                // Only validate if delivery is selected
                if (this.orderType === 'delivery' && this.selectedLocation && isDeliveryAvailable(this.selectedLocation)) {
                    const deliveryAddress = this.getDeliveryAddressValue();
                    const deliveryCity = document.getElementById('deliveryCity')?.value?.trim() || '';
                    const deliveryZip = document.getElementById('deliveryZip')?.value?.trim() || '';

                    if (!deliveryAddress || !deliveryCity || !deliveryZip) {
                        this.showStepError('Please fill in all delivery address fields.');
                        return false;
                    }

                    // Require address to be validated (either from autocomplete or manually typed and validated)
                    if (!this.deliveryZoneValid) {
                        if (!this.addressSelectedFromAutocomplete && !deliveryAddress) {
                            this.showStepError('Please enter your delivery address.');
                        } else {
                            this.showStepError('Please wait for your delivery address to be validated, or check that all address fields are filled correctly.');
                        }
                        return false;
                    }
                }
                return true;
            }

            validateStep3() {
                const date = this.getSelectedPickupDate();
                if (!date) {
                    this.showStepError('Please select a pickup/delivery date.');
                    return false;
                }

                if (!this.isValidPickupDate(date)) {
                    this.showStepError('The selected date is not available. Please choose a different date.');
                    return false;
                }
                return true;
            }

            validateStep4() {
                const name = document.getElementById('customerName').value.trim();
                const phone = document.getElementById('customerPhone').value.trim();
                const totalItems = this.cart.getTotalItems();

                if (!name) {
                    this.showStepError('Please enter your full name.');
                    return false;
                }

                if (!phone) {
                    this.showStepError('Please enter your phone number.');
                    return false;
                }

                // Check delivery minimum requirement
                if (this.orderType === 'delivery' && totalItems < 5) {
                    this.showStepError('Delivery requires a minimum of 5 bottles. Please add more items to your cart or choose pickup.');
                    return false;
                }

                return true;
            }

            showStepError(message) {
                // Remove existing error messages
                document.querySelectorAll('.step-error').forEach(error => error.remove());

                // Create error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'step-error';
                errorDiv.style.cssText = `
                    background: #f8d7da;
                    color: #721c24;
                    border: 1px solid #f5c6cb;
                    border-radius: 8px;
                    padding: 1rem;
                    margin: 1rem 0;
                    font-weight: bold;
                `;
                errorDiv.innerHTML = `<i class="ri-error-warning-line"></i> ${message}`;

                // Insert error message
                const currentStep = document.getElementById(`step${this.currentStep}`);
                const stepHeader = currentStep.querySelector('.step-header');
                stepHeader.insertAdjacentElement('afterend', errorDiv);

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 5000);
            }

            setupCartChangeListener() {
                // Listen for cart change events
                window.addEventListener('cartChanged', (event) => {
                    console.log('Cart change event received:', event.detail);
                    const newTotal = event.detail.totalItems;
                    const newItems = event.detail.items;
                    const previousTotal = this.cart.getTotalItems();

                    console.log('Previous total:', previousTotal, 'New total:', newTotal);

                    // Update our cart reference
                    this.cart.items = newItems;

                    // Always update delivery radio states when cart changes
                    console.log('Cart changed, updating delivery radio states');
                    this.updateDeliveryRadioStates();

                    // If cart total changed, update UI
                    if (newTotal !== previousTotal) {
                        console.log('Cart total changed, updating UI');

                        // If delivery is selected and no longer meets minimum, switch to pickup
                        if (this.orderType === 'delivery' && newTotal < 5) {
                            console.log('Switching from delivery to pickup due to minimum requirement');
                            this.orderType = 'pickup';

                            // Update radio buttons
                            const deliveryRadio = document.querySelector(`input[name="orderType_${this.selectedLocation}"][value="delivery"]`);
                            const pickupRadio = document.querySelector(`input[name="orderType_${this.selectedLocation}"][value="pickup"]`);
                            if (deliveryRadio && pickupRadio) {
                                deliveryRadio.checked = false;
                                pickupRadio.checked = true;
                            }

                            // Update UI
                            this.updateDeliverySection();
                            this.updateLocationHoursInfo();
                            this.populateOrderSummary();
                            this.updateStepButtons();
                            this.updateBackButtonText();
                            this.updateStepHeaders();
                            this.updateProgressIndicator(this.currentStep);

                            // Show warning message
                            this.showStepError('Delivery requires 5 bottles minimum. Your order has been switched to pickup.');
                        } else {
                            console.log('Updating UI without changing order type');
                            // Just update the UI without changing order type
                            this.populateLocations();
                            this.updateDeliverySection();
                            this.populateOrderSummary();
                            this.updateStepButtons();

                            // If order type was changed to pickup, update the UI
                            if (this.orderType === 'pickup') {
                                this.updateLocationHoursInfo();
                                this.updateBackButtonText();
                                this.updateStepHeaders();
                                this.updateProgressIndicator(this.currentStep);
                            }
                        }
                    }
                });
            }

            updateDeliveryRadioStates() {
                const totalItems = this.cart.getTotalItems();
                const hasMinimumForDelivery = totalItems >= 5;

                console.log('updateDeliveryRadioStates called - totalItems:', totalItems, 'hasMinimumForDelivery:', hasMinimumForDelivery);

                // Update all delivery radio buttons for all locations
                const deliveryRadios = document.querySelectorAll('input[value="delivery"]');
                const deliveryLabels = document.querySelectorAll('label:has(input[value="delivery"])');

                console.log('Found delivery radios:', deliveryRadios.length, 'delivery labels:', deliveryLabels.length);

                deliveryRadios.forEach(radio => {
                    const locationSlug = radio.name.replace('orderType_', '').replace('_delivery', '');
                    const deliveryAvailable = isDeliveryAvailable(locationSlug);
                    const isCurrentLocation = locationSlug === this.selectedLocation;

                    console.log('Processing radio for location:', locationSlug, 'deliveryAvailable:', deliveryAvailable, 'isCurrentLocation:', isCurrentLocation);

                    if (deliveryAvailable) {
                        // Always update the disabled state based on minimum requirement
                        radio.disabled = !hasMinimumForDelivery;
                        console.log('Set radio disabled to:', !hasMinimumForDelivery, 'for location:', locationSlug);

                        // If this is the current location and delivery is selected but no longer valid, switch to pickup
                        if (isCurrentLocation && this.orderType === 'delivery' && !hasMinimumForDelivery) {
                            const pickupRadio = document.querySelector(`input[name="orderType_${locationSlug}"][value="pickup"]`);
                            if (pickupRadio) {
                                pickupRadio.checked = true;
                                radio.checked = false;
                                this.orderType = 'pickup';
                                console.log('Switched to pickup for location:', locationSlug);
                            }
                        }
                    } else {
                        // If delivery is not available for this location, disable the radio
                        radio.disabled = true;
                        console.log('Delivery not available for location:', locationSlug, 'disabled radio');
                    }
                });

                deliveryLabels.forEach(label => {
                    const radio = label.querySelector('input[value="delivery"]');
                    if (radio) {
                        const locationSlug = radio.name.replace('orderType_', '').replace('_delivery', '');
                        const deliveryAvailable = isDeliveryAvailable(locationSlug);
                        const isCurrentLocation = locationSlug === this.selectedLocation;

                        if (deliveryAvailable) {
                            if (hasMinimumForDelivery) {
                                label.style.opacity = isCurrentLocation ? '1' : '0.5';
                                label.style.cursor = 'pointer';
                                label.title = '';
                            } else {
                                label.style.opacity = '0.3';
                                label.style.cursor = 'not-allowed';
                                label.title = 'Delivery requires 5 bottles minimum';
                            }
                            console.log('Updated label for location:', locationSlug, 'opacity:', label.style.opacity, 'cursor:', label.style.cursor, 'title:', label.title);
                        } else {
                            // If delivery is not available for this location, style accordingly
                            label.style.opacity = '0.3';
                            label.style.cursor = 'not-allowed';
                            label.title = 'Delivery not available for this location';
                            console.log('Delivery not available for location:', locationSlug, 'styled label as disabled');
                        }
                    }
                });
            }

            populateOrderSummaryReview() {
                // Clear any existing review sections and back button first
                const orderSummary = document.querySelector('.order-summary');
                if (orderSummary) {
                    const existingReviewSections = orderSummary.querySelectorAll('.review-section');
                    existingReviewSections.forEach(section => section.remove());
                    const existingBackButton = orderSummary.querySelector('.step-actions');
                    if (existingBackButton) {
                        existingBackButton.remove();
                    }
                }

                // Populate the existing order summary with review information
                this.populateOrderSummary();

                if (!orderSummary) return;

                let reviewHTML = `
                    <div class="review-section">
                        <h5><i class="ri-map-pin-line"></i> Location & Order Type</h5>
                        <p><strong>Location:</strong> ${getLocationBySlug(this.selectedLocation)?.name || 'Not selected'}</p>
                        <p><strong>Order Type:</strong> ${this.orderType === 'delivery' ? 'Delivery' : 'Pickup'}</p>
                `;

                if (this.orderType === 'delivery') {
                    const address = this.getDeliveryAddressValue();
                    const city = document.getElementById('deliveryCity')?.value || '';
                    const zip = document.getElementById('deliveryZip')?.value || '';
                    reviewHTML += `
                        <p><strong>Delivery Address:</strong> ${address}, ${city}, ${zip}</p>
                    `;
                }

                reviewHTML += `
                    </div>
                    <div class="review-section">
                        <h5><i class="ri-calendar-line"></i> Date & Time</h5>
                        <p><strong>Date:</strong> ${this.formatDateForDisplay(new Date(this.getSelectedPickupDate() + 'T00:00:00'))}</p>
                    </div>
                    <div class="review-section">
                        <h5><i class="ri-user-line"></i> Contact Information</h5>
                        <p><strong>Name:</strong> ${document.getElementById('customerName').value}</p>
                        <p><strong>Phone:</strong> ${document.getElementById('customerPhone').value}</p>
                    </div>
                `;

                // Insert review sections before the order items
                const orderItemsContainer = orderSummary.querySelector('#orderItems');
                if (orderItemsContainer) {
                    orderItemsContainer.insertAdjacentHTML('beforebegin', reviewHTML);
                }

                // Add back button and payment button to the order summary for full-screen mode
                const backButtonHTML = `
                    <div class="step-actions" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e9ecef;">
                        <button type="button" class="step-button prev-step" id="step5PrevFromSummary">Back to Contact Info</button>
                        <button type="button" class="step-button checkout-button" id="completeOrderButtonFromSummary" disabled>Proceed to Payment</button>
                    </div>
                `;

                // Insert back button after the order summary content
                const summaryTotals = orderSummary.querySelector('.summary-totals');
                if (summaryTotals) {
                    summaryTotals.insertAdjacentHTML('afterend', backButtonHTML);

                    // Add event listener to the back button
                    const backButton = orderSummary.querySelector('#step5PrevFromSummary');
                    if (backButton) {
                        backButton.addEventListener('click', () => {
                            this.goToStep(4);
                        });
                    }

                    // Add event listener to the payment button
                    const paymentButton = orderSummary.querySelector('#completeOrderButtonFromSummary');
                    if (paymentButton) {
                        paymentButton.addEventListener('click', () => {
                            this.processCheckout();
                        });
                    }
                }
            }

            setupDatePicker() {
                const dateInput = document.getElementById('pickupDate');

                // Hide the regular date input and always use custom calendar
                dateInput.style.display = 'none';

                // Disable date input until location is selected
                dateInput.disabled = true;

                dateInput.addEventListener('change', () => {
                    this.validatePickupDate();
                    this.validateForm();
                });
            }

            updateDatePickerForLocation() {
                if (!this.selectedLocation) return;

                const dateInput = document.getElementById('pickupDate');
                const currentValue = dateInput.value;
                const location = getLocationBySlug(this.selectedLocation);

                // Enable the date picker now that location is selected
                dateInput.disabled = false;

                // Always create custom calendar when location is selected
                this.createCustomCalendar();

                // Update the help text to show location-specific hours
                this.updateLocationHoursInfo();

                // Clear current selection if location changed
                dateInput.value = '';

                // If there was a previous date selected, validate it for the new location
                if (currentValue && !this.isValidPickupDate(currentValue)) {
                    this.showDateMessage('Please select a new pickup date - the selected location is closed on the previously chosen day.');
                }

                this.validateForm();
            }

            setupDateRestrictions() {
                if (!this.selectedLocation) return;

                const dateInput = document.getElementById('pickupDate');
                const location = getLocationBySlug(this.selectedLocation);

                // Remove any existing event listener
                if (this.dateInputHandler) {
                    dateInput.removeEventListener('input', this.dateInputHandler);
                }

                // Create a new handler that prevents selecting closed days
                this.dateInputHandler = (e) => {
                    const selectedDate = e.target.value;
                    if (selectedDate && !this.isValidPickupDate(selectedDate)) {
                        e.target.value = '';
                        const locationName = location ? location.name : 'Selected location';
                        this.showDateMessage(`${locationName} is closed on the selected date. Please choose a different day.`);
                        return false;
                    }
                    this.clearDateMessage();
                    this.validateForm();
                };

                // Add the new event listener
                dateInput.addEventListener('input', this.dateInputHandler);

                // Also prevent keyboard input of invalid dates
                dateInput.addEventListener('keydown', (e) => {
                    // Allow navigation keys
                    if (['Tab', 'Escape', 'Enter', 'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                        return;
                    }
                });

                // Use CSS to disable closed days in the calendar
                this.setupCalendarRestrictions();
            }

            setupCalendarRestrictions() {
                const dateInput = document.getElementById('pickupDate');
                const location = getLocationBySlug(this.selectedLocation);

                // Remove any existing select dropdown
                const existingSelect = document.getElementById('pickupDateSelect');
                if (existingSelect) {
                    existingSelect.remove();
                }

                // Create custom calendar that shows disabled days
                this.createCustomCalendar();
            }

            createCustomCalendar() {
                const dateInput = document.getElementById('pickupDate');
                const location = getLocationBySlug(this.selectedLocation);

                // Hide the original date input
                dateInput.style.display = 'none';

                // Remove existing custom calendar
                const existingCalendar = document.getElementById('customCalendar');
                if (existingCalendar) {
                    existingCalendar.remove();
                }

                // Create custom calendar container
                const calendarContainer = document.createElement('div');
                calendarContainer.id = 'customCalendar';
                calendarContainer.className = 'custom-calendar';

                // Insert after the date input
                dateInput.parentNode.insertBefore(calendarContainer, dateInput.nextSibling);

                // Initialize calendar
                this.initCustomCalendar(calendarContainer);

                // Add custom calendar styles
                this.addCustomCalendarStyles();
            }

            initCustomCalendar(container) {
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();

                // Always start with current month - never allow going backwards
                this.currentCalendarMonth = currentMonth;
                this.currentCalendarYear = currentYear;

                this.renderCalendar(container);
            }

            renderCalendar(container) {
                const location = getLocationBySlug(this.selectedLocation);
                const today = new Date();
                const firstDay = new Date(this.currentCalendarYear, this.currentCalendarMonth, 1);
                const lastDay = new Date(this.currentCalendarYear, this.currentCalendarMonth + 1, 0);
                const firstDayOfWeek = firstDay.getDay();
                const daysInMonth = lastDay.getDate();

                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];

                // Check if we're in the current month to disable previous button
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const isCurrentMonth = this.currentCalendarMonth === currentMonth && this.currentCalendarYear === currentYear;
                const prevButtonDisabled = isCurrentMonth ? 'disabled' : '';
                const prevButtonClass = isCurrentMonth ? 'calendar-nav disabled' : 'calendar-nav';

                let html = `
                    <div class="calendar-header">
                        <button type="button" class="${prevButtonClass}" id="prevMonth" ${prevButtonDisabled}>&lt;</button>
                        <span class="calendar-month-year">${monthNames[this.currentCalendarMonth]} ${this.currentCalendarYear}</span>
                        <button type="button" class="calendar-nav" id="nextMonth">&gt;</button>
                    </div>
                    <div class="calendar-days-header">
                        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                    </div>
                    <div class="calendar-grid">
                `;

                // Add empty cells for days before the first day of the month
                for (let i = 0; i < firstDayOfWeek; i++) {
                    html += '<div class="calendar-day empty"></div>';
                }

                // Add days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(this.currentCalendarYear, this.currentCalendarMonth, day);
                    const dateString = currentDate.toISOString().split('T')[0];
                    const isPast = currentDate < today;
                    const isToday = currentDate.toDateString() === today.toDateString();
                    const isFuture = currentDate > today;
                    const dayOfWeek = currentDate.getDay();
                    const isMonday = dayOfWeek === 1;

                    // Check if this Monday is available based on Thursday cutoff
                    let isAvailableMonday = false;
                    let unavailableReason = '';

                    if (isMonday && isFuture) {
                        // Calculate the Thursday before this Monday (Monday minus 4 days)
                        const thursdayBeforeMonday = new Date(currentDate);
                        thursdayBeforeMonday.setDate(currentDate.getDate() - 4);
                        thursdayBeforeMonday.setHours(23, 59, 59, 999);

                        const todayDate = new Date();
                        todayDate.setHours(0, 0, 0, 0);

                        // Check if we're still before the Thursday cutoff
                        const beforeCutoff = todayDate <= thursdayBeforeMonday;
                        const locationOpen = isLocationOpenOnDate(this.selectedLocation, currentDate);

                        if (!beforeCutoff) {
                            unavailableReason = 'Order deadline passed (must order by Thursday)';
                        } else if (!locationOpen) {
                            unavailableReason = `${location.name} is closed on this Monday`;
                        } else {
                            isAvailableMonday = true;
                        }
                    }

                    let classes = 'calendar-day';
                    if (isPast) classes += ' past';
                    if (isToday) classes += ' today';
                    if (!isMonday && isFuture) classes += ' closed';
                    if (isMonday && isFuture && !isAvailableMonday) classes += ' closed';
                    if (isAvailableMonday) classes += ' available';

                    const clickable = isAvailableMonday ? `onclick="checkoutPage.selectDate('${dateString}')"` : '';
                    const title = isPast ? 'Past date' :
                        isToday ? 'Today (select Monday or later)' :
                            !isMonday ? 'Only Mondays available for pickup/delivery' :
                                unavailableReason ? unavailableReason :
                                    'Available for pickup/delivery';

                    html += `<div class="${classes}" ${clickable} title="${title}" data-date="${dateString}">${day}</div>`;
                }

                html += '</div>';
                container.innerHTML = html;

                // Add event listeners for navigation
                document.getElementById('prevMonth').addEventListener('click', (e) => {
                    // Don't allow going to previous months if button is disabled
                    if (e.target.disabled) return;

                    this.currentCalendarMonth--;
                    if (this.currentCalendarMonth < 0) {
                        this.currentCalendarMonth = 11;
                        this.currentCalendarYear--;
                    }
                    this.renderCalendar(container);
                });

                document.getElementById('nextMonth').addEventListener('click', () => {
                    this.currentCalendarMonth++;
                    if (this.currentCalendarMonth > 11) {
                        this.currentCalendarMonth = 0;
                        this.currentCalendarYear++;
                    }
                    this.renderCalendar(container);
                });
            }

            selectDate(dateString) {
                const dateInput = document.getElementById('pickupDate');
                dateInput.value = dateString;

                // Update visual selection in calendar
                document.querySelectorAll('.calendar-day').forEach(day => {
                    day.classList.remove('selected');
                });

                const selectedDay = document.querySelector(`[data-date="${dateString}"]`);
                if (selectedDay) {
                    selectedDay.classList.add('selected');
                }

                this.clearDateMessage();
                this.validateForm();
                this.updateStepButtons();
            }

            addCustomCalendarStyles() {
                // Remove existing styles
                const existingStyle = document.getElementById('custom-calendar-styles');
                if (existingStyle) {
                    existingStyle.remove();
                }

                const styleElement = document.createElement('style');
                styleElement.id = 'custom-calendar-styles';
                styleElement.textContent = `
                    .custom-calendar {
                        border: 2px solid #ddd;
                        border-radius: 8px;
                        background: white;
                        padding: 1rem;
                        font-family: inherit;
                        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                    }
                    
                    .calendar-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 1rem;
                        padding-bottom: 0.5rem;
                        border-bottom: 1px solid #eee;
                    }
                    
                    .calendar-nav {
                        background: #ff9700;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        padding: 0.5rem;
                        cursor: pointer;
                        font-weight: bold;
                        min-width: 32px;
                        height: 32px;
                    }
                    
                    .calendar-nav:hover:not(.disabled) {
                        background: #ff7700;
                    }
                    
                    .calendar-nav.disabled {
                        background: #ccc !important;
                        color: #666 !important;
                        cursor: not-allowed !important;
                        opacity: 0.5;
                    }
                    
                    .calendar-month-year {
                        font-weight: bold;
                        font-size: 1.1rem;
                        color: #333;
                    }
                    
                    .calendar-days-header {
                        display: grid;
                        grid-template-columns: repeat(7, 1fr);
                        gap: 0.25rem;
                        margin-bottom: 0.5rem;
                    }
                    
                    .calendar-days-header span {
                        text-align: center;
                        font-weight: bold;
                        color: #666;
                        padding: 0.5rem;
                        font-size: 0.9rem;
                    }
                    
                    .calendar-grid {
                        display: grid;
                        grid-template-columns: repeat(7, 1fr);
                        gap: 0.25rem;
                    }
                    
                    .calendar-day {
                        aspect-ratio: 1;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 4px;
                        font-weight: bold;
                        position: relative;
                        transition: all 0.2s ease;
                    }
                    
                    .calendar-day.empty {
                        visibility: hidden;
                    }
                    
                    .calendar-day.past {
                        color: #ccc;
                        background: #f9f9f9;
                    }
                    
                    .calendar-day.today {
                        color: #666;
                        background: #f0f0f0;
                        border: 1px solid #ddd;
                    }
                    
                    .calendar-day.closed {
                        color: #dc3545;
                        background: #fff5f5;
                        border: 1px solid #f8d7da;
                        cursor: not-allowed;
                        position: relative;
                    }
                    
                    .calendar-day.closed::after {
                        content: "";
                        position: absolute;
                        top: 2px;
                        right: 2px;
                        font-size: 0.6rem;
                        color: #dc3545;
                    }
                    
                    .calendar-day.available {
                        color: #333;
                        background: #f8f9fa;
                        border: 1px solid #e9ecef;
                        cursor: pointer;
                    }
                    
                    .calendar-day.available:hover {
                        background: #fff3e0;
                        border-color: #ff9700;
                        transform: scale(1.05);
                    }
                    
                    .calendar-day.selected {
                        background: #ff9700 !important;
                        color: white !important;
                        border-color: #ff7700 !important;
                        font-weight: bold;
                    }
                `;

                document.head.appendChild(styleElement);
            }

            formatDateForDisplay(date) {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const months = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];

                const dayName = days[date.getDay()];
                const monthName = months[date.getMonth()];
                const day = date.getDate();
                const year = date.getFullYear();

                return `${dayName}, ${monthName} ${day}, ${year}`;
            }

            getSelectedPickupDate() {
                // Get the date from the calendar input
                return document.getElementById('pickupDate').value;
            }

            updateLocationHoursInfo() {
                const infoSpan = document.getElementById('location-hours-info');
                if (!infoSpan || !this.selectedLocation) return;

                const location = getLocationBySlug(this.selectedLocation);
                if (!location) return;

                const today = new Date();
                const dayOfWeek = today.getDay();
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const currentDay = dayNames[dayOfWeek];

                // New ordering schedule
                let message = `New ordering schedule: Orders must be placed by Thursday at midnight. Prep Saturday, ship Sunday, ${this.orderType === 'delivery' ? 'deliver' : 'pickup'} Monday. `;

                // Add deadline information based on current day
                if (dayOfWeek <= 3) { // Monday to Wednesday
                    const daysUntilThursday = 4 - dayOfWeek;
                    message += `Orders must be placed by Thursday at midnight. `;
                } else if (dayOfWeek === 4) { // Thursday
                    message += ` Today is the order deadline! Orders must be placed by midnight tonight. `;
                } else { // Friday through Monday
                    message += ` Order deadline has passed. Next available ${this.orderType === 'delivery' ? 'delivery' : 'pickup'} is the Monday after next. `;
                }

                if (this.orderType === 'delivery') {
                    message += `Only Mondays are available for delivery. `;
                    message += `Delivery within ${getDeliveryRadius(this.selectedLocation)} miles of ${location.name}. `;
                    message += `${location.name} is open on Mondays: ${location.pickupHours.monday || 'Closed'}.`;
                } else {
                    message += `Only Mondays are available for pickup. `;
                    message += `${location.name} is open on Mondays: ${location.pickupHours.monday || 'Closed'}.`;
                }

                infoSpan.textContent = message;
            }

            isValidPickupDate(dateString) {
                if (!this.selectedLocation || !dateString) return false;

                try {
                    const selectedDate = new Date(dateString + 'T00:00:00');
                    const dayOfWeek = selectedDate.getDay(); // 0 = Sunday, 1 = Monday, etc.

                    // New schedule: Only allow Mondays for pickup/delivery
                    if (dayOfWeek !== 1) { // Not Monday
                        return false;
                    }

                    // Check if this Monday is eligible based on Thursday cutoff
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // Reset to start of day for comparison

                    // Calculate the Thursday before this Monday
                    // If the Monday is on day X, the Thursday before it is on day X-4
                    const thursdayBeforeMonday = new Date(selectedDate);
                    thursdayBeforeMonday.setDate(selectedDate.getDate() - 4);
                    thursdayBeforeMonday.setHours(23, 59, 59, 999); // Set to end of Thursday (11:59:59 PM)

                    // Order must be placed before or on Thursday 11:59 PM to qualify for that Monday
                    // If today is after Thursday 11:59 PM, this Monday is not available
                    if (today > thursdayBeforeMonday) {
                        return false;
                    }

                    // Check if location is open on Monday
                    return isLocationOpenOnDate(this.selectedLocation, selectedDate);
                } catch (error) {
                    console.error('Error validating pickup date:', error);
                    return false;
                }
            }

            validatePickupDate() {
                const selectedDate = this.getSelectedPickupDate();

                if (!selectedDate || !this.selectedLocation) return true;

                if (!this.isValidPickupDate(selectedDate)) {
                    const location = getLocationBySlug(this.selectedLocation);
                    const locationName = location ? location.name : 'Selected location';
                    const selectedDateObj = new Date(selectedDate + 'T00:00:00');
                    const dayOfWeek = selectedDateObj.getDay();
                    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

                    let errorMessage;
                    if (dayOfWeek !== 1) {
                        errorMessage = `Only Mondays are available for ${this.orderType === 'delivery' ? 'delivery' : 'pickup'}. Please select a Monday.`;
                    } else {
                        errorMessage = `${locationName} is closed on the selected Monday. Please choose a different Monday.`;
                    }

                    this.showDateMessage(errorMessage);

                    // Clear both inputs
                    document.getElementById('pickupDate').value = '';
                    const selectElement = document.getElementById('pickupDateSelect');
                    if (selectElement) selectElement.value = '';

                    return false;
                }

                this.clearDateMessage();
                return true;
            }

            showDateMessage(message) {
                // Remove existing message
                this.clearDateMessage();

                const dateInput = document.getElementById('pickupDate');
                const messageDiv = document.createElement('div');
                messageDiv.id = 'date-validation-message';
                messageDiv.style.cssText = `
                    color: #dc3545;
                    font-size: 0.875rem;
                    margin-top: 0.5rem;
                    padding: 0.5rem;
                    background: #f8d7da;
                    border: 1px solid #f5c6cb;
                    border-radius: 4px;
                `;
                messageDiv.textContent = message;

                dateInput.parentNode.appendChild(messageDiv);
            }

            clearDateMessage() {
                const existingMessage = document.getElementById('date-validation-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
            }

            setupFormValidation() {
                const inputs = document.querySelectorAll('input[required]');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        this.validateForm();
                        this.updateStepButtons();
                    });
                });

                // Add listeners for delivery fields
                const deliveryInputs = ['deliveryAddress', 'deliveryCity', 'deliveryZip'];
                deliveryInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', () => {
                            this.updateStepButtons();
                            // Auto-check delivery zone when all fields are filled
                            this.autoCheckDeliveryZone();
                        });
                    }
                });

                // Add listener for date input
                const dateInput = document.getElementById('pickupDate');
                if (dateInput) {
                    dateInput.addEventListener('change', () => {
                        this.updateStepButtons();
                    });
                }
            }

            validateForm() {
                const name = document.getElementById('customerName')?.value;
                const phone = document.getElementById('customerPhone')?.value;
                const date = this.getSelectedPickupDate();
                const location = this.selectedLocation;

                // Check if all fields are filled and date is valid for the selected location
                let isBasicDataValid = name && phone && date && location && Object.keys(this.cart.items).length > 0;
                const isDateValid = !date || !location || this.isValidPickupDate(date);

                // If delivery is selected, validate delivery fields and zone
                if (this.orderType === 'delivery' && location && isDeliveryAvailable(location)) {
                    const deliveryAddress = this.getDeliveryAddressValue();
                    const deliveryCity = document.getElementById('deliveryCity')?.value?.trim() || '';
                    const deliveryZip = document.getElementById('deliveryZip')?.value?.trim() || '';
                    isBasicDataValid = isBasicDataValid && deliveryAddress && deliveryCity && deliveryZip && this.deliveryZoneValid;
                }

                const isValid = isBasicDataValid && isDateValid;
                // Button validation is now handled in updateStepButtons() for step 5
            }

            populateOrderSummary() {
                const orderItemsContainer = document.getElementById('orderItems');
                const cartSubtotal = this.cart.getTotal();
                let subtotal = cartSubtotal;

                // Add delivery fee if delivery is selected (FREE shipping over $50)
                let deliveryFee = 0;
                let isFreeShipping = false;
                if (this.orderType === 'delivery' && this.selectedLocation && isDeliveryAvailable(this.selectedLocation)) {
                    if (cartSubtotal >= 50) {
                        deliveryFee = 0;
                        isFreeShipping = true;
                    } else {
                        deliveryFee = getDeliveryFee(this.selectedLocation);
                    }
                    subtotal += deliveryFee;
                }

                const total = subtotal;

                // Populate items
                let itemsHTML = '';
                Object.entries(this.cart.items).forEach(([juiceId, quantity]) => {
                    const juice = juices.find(j => j.id === parseInt(juiceId));
                    if (juice) {
                        itemsHTML += `
                            <div class="order-item" style="border-left: 4px solid ${juice.color};">
                                <img src="${juice.imageUrl}" alt="${juice.name}">
                                <div class="item-details">
                                    <h4 style="color: ${juice.color}; font-family: var(--second-font); font-size: 1rem;">${juice.name}</h4>
                                    <p>$${juice.price.toFixed(2)} each</p>
                                    <div class="quantity-controls">
                                        <button onclick="checkoutPage.removeItem(${juice.id})" style="background-color: ${juice.color}">-</button>
                                        <span>${quantity}</span>
                                        <button onclick="checkoutPage.addItem(${juice.id})" style="background-color: ${juice.color}">+</button>
                                    </div>
                                </div>
                                <div class="item-price">
                                    $${(juice.price * quantity).toFixed(2)}
                                </div>
                            </div>
                        `;
                    }
                });

                orderItemsContainer.innerHTML = itemsHTML;

                // Update totals
                document.getElementById('subtotalAmount').textContent = `$${cartSubtotal.toFixed(2)}`;

                // Add delivery fee line if applicable
                const summaryTotals = document.querySelector('.summary-totals');
                let existingDeliveryLine = document.getElementById('deliveryFeeLine');

                // Always remove existing delivery line first
                if (existingDeliveryLine) {
                    existingDeliveryLine.remove();
                }

                // Add delivery fee line if delivery is selected
                if (this.orderType === 'delivery' && this.selectedLocation && isDeliveryAvailable(this.selectedLocation)) {
                    const deliveryLine = document.createElement('div');
                    deliveryLine.id = 'deliveryFeeLine';
                    deliveryLine.className = 'summary-line';

                    if (isFreeShipping) {
                        deliveryLine.innerHTML = `
                            <span>Delivery Fee:</span>
                            <span style="color: #28a745; font-weight: bold;">FREE <i class="ri-gift-line"></i></span>
                        `;
                    } else {
                        const amountNeeded = (50 - cartSubtotal).toFixed(2);
                        deliveryLine.innerHTML = `
                            <span>Delivery Fee:<br><small style="color: #ff9700; font-size: 0.75rem;">Add $${amountNeeded} for FREE shipping!</small></span>
                            <span>$${deliveryFee.toFixed(2)}</span>
                        `;
                    }
                    summaryTotals.insertBefore(deliveryLine, summaryTotals.querySelector('.summary-line.total'));
                }

                document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
            }

            setupCheckoutButton() {
                // The checkout button is now set up in populateOrderSummaryReview()
                // when the order summary is populated for step 5
            }

            addItem(juiceId) {
                this.cart.addItem(juiceId);
                this.populateOrderSummary();
                this.validateForm();
            }

            removeItem(juiceId) {
                this.cart.removeItem(juiceId);
                this.populateOrderSummary();
                this.validateForm();

                // Redirect to juices page if cart becomes empty
                if (Object.keys(this.cart.items).length === 0) {
                    window.location.href = '/juices';
                }
            }

            async processCheckout() {
                const button = document.querySelector('#completeOrderButtonFromSummary');
                if (button) {
                    button.disabled = true;
                    button.textContent = 'Processing...';
                }

                // Final validation check for delivery minimum
                const totalItems = this.cart.getTotalItems();
                if (this.orderType === 'delivery' && totalItems < 5) {
                    if (button) {
                        button.disabled = false;
                        button.textContent = 'Proceed to Payment';
                    }
                    this.showStepError('Delivery requires a minimum of 5 bottles. Please add more items to your cart or choose pickup.');
                    return;
                }

                try {
                    const checkoutData = {
                        items: Object.entries(this.cart.items).map(([juiceId, quantity]) => {
                            const juice = juices.find(j => j.id === parseInt(juiceId));
                            return {
                                price_data: {
                                    currency: 'usd',
                                    product_data: {
                                        name: juice.name,
                                        description: juice.description,
                                        images: [juice.imageUrl]
                                    },
                                    unit_amount: Math.round(juice.price * 100)
                                },
                                quantity: quantity
                            };
                        }),
                        pickupDate: this.getSelectedPickupDate(),
                        pickupLocation: this.selectedLocation,
                        orderType: this.orderType,
                        customerName: document.getElementById('customerName').value,
                        customerPhone: document.getElementById('customerPhone').value
                    };

                    // Add delivery information if delivery is selected
                    if (this.orderType === 'delivery') {
                        checkoutData.deliveryAddress = this.getDeliveryAddressValue();
                        checkoutData.deliveryCity = document.getElementById('deliveryCity')?.value || '';
                        checkoutData.deliveryZip = document.getElementById('deliveryZip')?.value || '';
                        checkoutData.deliveryFee = getDeliveryFee(this.selectedLocation);
                    }

                    const response = await fetch('/create-checkout-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(checkoutData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const {
                        url
                    } = await response.json();
                    if (!url) {
                        throw new Error('No checkout URL received');
                    }

                    window.location.href = url;
                } catch (error) {
                    console.error('Error during checkout:', error);
                    alert('There was an error processing your checkout. Please try again.');
                    button.disabled = false;
                    button.textContent = 'Proceed to Payment';
                }
            }
        }

        // Initialize checkout page when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Redirect to juices page if cart is empty
            const cart = window.cart || new Cart();
            if (Object.keys(cart.items).length === 0) {
                window.location.href = '/juices';
                return;
            }

            // Disable cart flyout on checkout page
            const cartButton = document.querySelector('.cart-button');
            if (cartButton) {
                cartButton.style.pointerEvents = 'none';
                cartButton.style.opacity = '0.6';
            }

            // Disable cart overlay functionality
            const cartOverlay = document.getElementById('cartOverlay');
            if (cartOverlay) {
                cartOverlay.style.display = 'none !important';
            }

            // Override cart methods to prevent flyout
            if (window.cart) {
                window.cart.openCart = () => { }; // Disable cart opening
                window.cart.closeCart = () => { }; // Disable cart closing
            }

            window.checkoutPage = new CheckoutPage();

            // If Google Maps API was already loaded before checkout page was ready, initialize autocomplete now
            if (window.googleMapsApiLoaded) {
                window.checkoutPage.initializeAddressAutocomplete();
            }
        });
    </script>
</body>

</html>